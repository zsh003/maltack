## 1.1 系统详细设计及功能实现

### 1.1.1 系统功能概述

本系统主要包含样本管理模块、特征提取模块、集成学习与检测模块、数据可视化与前端展示模块等四个模块，通过菜单、按钮、用户信息引导等多种方式，能够让用户定位系统功能点。本节后续小节将逐一展开各功能模块的详细设计及实现的说明。



### 1.1.2 样本管理模块

样本管理模块是系统的数据基础与交互入口，负责PE样本的接收、存储、检索与展示。样本上传功能作为起始环节，允许用户通过前端界面（对应frontend/src/pages/upload/index.tsx中的UploadPage组件）选择本地PE文件（支持.exe, .dll, .sys等格式）。文件选定后，前端触发对后端POST /api/upload接口的调用。后端FastAPI服务（backend/app/main.py中的upload_sample函数）接收到文件流后，首先计算文件的MD5哈希值以作唯一标识，并将文件内容存储于服务器指定目录（如uploads/）。随后，后端调用insert_sample函数（定义于backend/app/database.py）将样本的基本元数据（文件名、哈希、大小等）存入数据库samples表。紧接着，后端自动触发特征提取流程，并将最终的检测结果（是否恶意、分类文本）更新回数据库。整个过程通过前端步骤条（Steps组件）向用户展示进度，分析完成后提示用户并提供查看详情的链接。


（1）样本列表与搜索功能

提供了对已上传样本的集中管理视图。前端通过调用GET /api/samples接口（后端调用get_all_samples函数）获取所有样本的基本信息，并在Ant Design的Table组件中分页展示，包含ID、文件名、哈希、大小、分析时间和检测结果等关键字段。表格支持按文件大小、分析时间等字段排序。此外，页面提供搜索框，允许用户输入文件名或MD5哈希值进行快速过滤。搜索逻辑可在前端实现，通过useState管理过滤条件并更新filteredSamples状态；或在后端接口层面支持查询参数，提高大规模数据下的检索效率。

样本上传页面如图6-1所示。



分析完成后xxxx，如图6-2所示。


（2）样本详情功能

是深入分析单个样本的核心界面。当用户在列表页点击特定样本时，前端路由（umi history.push）跳转至详情页，并将样本ID作为参数。详情页通过调用GET /api/samples/{id}接口（后端调用get_sample_by_id函数），从数据库一次性获取该样本的完整信息，包括基础信息以及关联的histogram_features、pe_features、engineered_features、lief_features等所有特征数据。前端使用Tabs组件将这些信息分门别类地展示，每个标签页下利用专门设计的React组件（如ByteHistogramChart、PEFeaturesCard、LiefAnalysisCard、FeatureEngineeringCard等）对相应的特征数据进行结构化呈现和可视化，便于用户全面理解样本的静态属性、结构特点和潜在风险。

系统记录样本的提交情况，在后台可查看已提交的样本列表，通过表格展示了其基本分析结果，表格支持分页和查找功能。若要查看详细信息，点击相应的记录可切换到对应的特征提取和分析结果页面，如图6-3所示



查找框中可以输入样本名或者哈希值，快速查找到所需要查看的样本，如图6-4所示



### 1.1.3 特征提取模块

直方图特征、PE静态特征、特征工程、LIEF深度分析
特征提取模块是系统的核心分析引擎，负责从原始PE样本中抽取多维度、多层次的特征信息，为后续的机器学习检测和人工分析提供数据支撑。该模块集成了多种先进的特征提取技术，旨在全面刻画PE文件的静态属性和潜在行为模式。
 

（1）直方图特征

提取专注于文件内容的统计分布特性。系统计算两种直方图：字节分布直方图（ByteHistogram().raw_features函数实现），统计0-255每个字节值在整个文件中的出现频率，归一化后得到256维向量；以及字节熵直方图（ByteEntropyHistogram().raw_features函数实现），通过滑动窗口计算局部熵值，并统计不同熵值区间的字节分布，同样生成256维向量。这两种特征融合为512维向量，对检测文件是否经过加密、压缩或包含大量特定数据（如填充数据）具有重要意义，它们直接作为后续卷积神经网络（CNN）模型的输入。特征向量在存入histogram_features表前会进行JSON序列化。

 

\- 关键函数：`ByteHistogram().raw_features`、`ByteEntropyHistogram().raw_features`



（2）PE静态特征

提取则深入PE文件结构本身，依据EMBER数据集提出的方法论，利用LIEF库（lief.PE.parse函数）解析PE文件。系统提取的关键结构信息包括：通用文件信息（GeneralFileInfo，如调试信息、TLS段、重定位信息大小）、PE头信息（HeaderFileInfo，如机器类型、时间戳、节区数量、特性标志）、节区信息（SectionInfo，涵盖名称、大小、熵、虚拟地址/大小、内存属性）以及导出表信息（ExportsInfo，导出函数名称、地址等）。由于导入表可能被破坏或混淆，原始方法中的ImportsInfo在此阶段可能无法完整提取。提取出的原始信息包含数值和类别型数据，系统通过PEFeatureExtractor类进行组织，并利用SectionInfo.process_raw_features等方法中的特征哈希（sklearn.feature_extraction.FeatureHasher）技术，将节区名称、属性等非数值特征与它们的数值属性（如大小、熵）结合，映射为固定长度（如50维）的数值向量，最终组合成967维的结构化特征向量。这些特征被设计用于训练和驱动集成学习模型（如Stacking模型），存储于pe_features表中。
 

\- 关键函数：`PEFeatureExtractor`、`SectionInfo.process_raw_features`



（3）LIEF深度分析



对PE静态特征提取的补充和验证，提供了未经机器学习处理的、更原始和详尽的PE结构信息。同样基于lief.PE.parse的解析结果，系统将解析出的DOS头、标准PE头、可选PE头、详细节区列表（包含权限等）、导入表（函数列表）、导出表、TLS结构、资源目录树等信息，通过LiefFeatureExtractor进行结构化整理，并以JSON格式直接存入lief_features数据库表。这些原始信息主要用于前端LiefAnalysisCard组件的直接展示，供专业分析人员进行细致的人工审查和深度分析，辅助理解PE文件的底层构造。

 

\- 关键函数：`lief.PE.parse`，`LiefFeatureExtractor`



（4）特征工程

它整合了五类关键特征：节区信息统计（如入口点节区名长度、可读/写/执行节区的大小和熵的均值、资源节区数量、节区总数，基于LIEF分析结果计算）；字符串模式匹配（string_match函数利用正则表达式匹配常见的可疑字符串，如加密货币钱包地址、文件路径、注册表项、URL、IP地址以及"MZ"、"PE"等指示性标记）；Yara规则匹配（yara_match函数应用预置的通用恶意规则和加壳规则集，以及可能的用户自定义规则，统计匹配到的规则数量）；关键字扫描（string_count函数统计特定敏感词汇的出现次数，如常见杀毒软件进程名、调试器名、矿池域名、加密算法名、虚拟货币名等）；以及Opcode分析（opcodes函数尝试通过正则表达式定位函数边界，使用capstone等反汇编引擎提取函数内的操作码序列，并计算其统计特征，如最小/最大/总和/均值/方差/数量/唯一操作码数）。这五部分特征被组合成一个56维的向量，专门用于驱动LightGBM等对高阶特征敏感的模型，结果存储在engineered_features表中。

 

\- 关键函数：`Feature_engineering.get_feature_engineering`





### 1.1.4 集成学习与检测模块

集成学习与检测模块是系统的智能决策核心，负责利用前一阶段提取的多维度特征，通过先进的机器学习模型对PE样本进行恶意性判别。为了充分发挥不同特征类型的优势并提高检测的鲁棒性和准确性，系统采用了复杂的多层集成学习架构。该架构的核心思想是并行处理异构特征，然后通过高级模型或策略融合各部分的预测结果。

模型架构如图6-5所示。

\- **直方图CNN模型**：输入512维特征，卷积提取空间分布，检测加密/混淆

\- **PE静态特征集成模型**：9个基模型（LR、XGB、RF等）+ 随机森林元模型，堆叠融合

\- **特征工程LightGBM模型**：处理专家特征，提升对挖矿/加壳等检测能力

\- **加权融合**：最终结果由各模型加权投票，提升准确率

\- **关键逻辑**：多进程特征提取、K折交叉验证、特征哈希、模型堆叠


模型整体架构遵循三路并行处理、一级融合的模式。第一路针对直方图特征，采用专门设计的卷积神经网络（CNN）模型。该模型接收512维的直方图特征输入，通过Reshape层将其视为32x16的二维伪图像，利用小型卷积核（如2x2）的Conv2D层和MaxPooling2D层有效捕捉字节值和熵值在文件“空间”上的局部统计模式和突变，这对于识别加密、加壳或混淆代码产生的高熵或异常分布区域特别有效。后续的全连接层（Dense）和Sigmoid输出层完成最终的二分类概率预测。
第二路处理PE静态特征，采用了基于堆叠（Stacking）的集成模型。首先，将提取的967维PE结构化特征输入到一组（例如9个）异构的基学习器中，这些基学习器涵盖了多种经典算法，如逻辑回归（LogisticRegression）、梯度提升树（GradientBoostingClassifier）、XGBoost（XGBClassifier）、随机森林（RandomForestClassifier）、支持向量机（LinearSVC）等。为了防止过拟合，基模型的训练通常结合K折交叉验证（例如5折），生成每个样本的Out-of-Fold (OOF)预测结果。这些OOF预测结果（即每个基模型对验证集样本的预测概率）被堆叠起来，形成新的特征集。然后，一个元学习器（Meta-learner），例如随机森林（rfc_pe_model），被训练来学习如何最优地组合这些基模型的预测，输出一个更稳定和准确的分类结果。
第三路则聚焦于特征工程提取出的56维高级特征。考虑到这些特征是基于专家知识构建的，具有较强的区分潜力，系统选用LightGBM模型（一种高效的梯度提升决策树实现）进行处理。LightGBM以其处理表格数据的高效性和优异性能而闻名，能够很好地捕捉这些高级特征之间的复杂非线性关系。
最终，这三路模型（CNN、PE特征集成模型的元学习器、LightGBM）各自输出对样本的恶意性预测概率。系统在决策层采用加权融合策略（Weighted Fusion），根据预先设定或动态学习得到的权重（例如，参考machine_learning/ensemble_learning/README.md中提到的x[1]*0.6 + y[1]*0.4 < 0.5的示例逻辑，但具体权重和融合模型可能根据实际调优确定），对三个模型的输出概率进行加权平均或投票，得到最终的判别结果（恶意或正常）。这一多模型、多特征、多层次的集成策略，旨在最大限度地结合不同信息源的优势，克服单一模型或单一特征类型的局限性，实现对各类恶意PE样本，包括经过混淆、加壳或采用非常规技术的样本的高效精准检测。关键的实现逻辑包括特征提取阶段的多进程处理（multiprocessing.Pool）、模型训练中的交叉验证和OOF预测生成、PE特征处理中的特征哈希技术，以及最终的模型堆叠和加权融合策略。


经过xxx分析后，得到特征得分，最终能够展示检测结果，如图6-6所示。



### 1.1.5 数据可视化与前端展示模块

数据可视化与前端展示模块作为系统的用户交互界面，承担着将后台复杂的分析结果以直观、易懂、可交互的方式呈现给用户的关键任务。该模块基于React框架，利用UmiJS进行路由和状态管理，结合Ant Design组件库构建美观统一的UI界面，并大量采用ECharts图表库实现丰富的数据可视化效果。

（1）仪表盘

是系统的概览入口。它通过调用GET /api/stats和GET /api/samples接口获取全局统计数据和近期样本信息。页面顶部使用Ant Design的Statistic卡片展示核心指标，如总样本数、恶意样本数、正常样本数和整体检测率。中部则利用ECharts绘制两个核心图表：一个样本分类饼图（pieOption配置），展示恶意与正常样本的比例分布；一个样本大小分布柱状图（barOption配置），显示不同文件大小区间的样本数量。页面底部通常会展示一个近期上传样本的简略列表（Table组件），方便用户快速了解最新动态。

（2）样本详情页面

是可视化展示的核心区域。它通过Ant Design的Tabs组件将单个样本的多种分析结果清晰地组织起来。每个标签页专注于一类特征：直方图特征页利用自定义的ByteHistogramChart和EntropyHistogramChart组件（内部使用ECharts）分别绘制字节分布和字节熵直方图；PE静态特征页使用PEFeaturesCard组件，通过Descriptions和Table展示PE头信息、节区详细属性（熵值高低、内存权限等通过不同颜色或图标标示）、导出表等；LIEF分析页则借助LiefAnalysisCard组件，以折叠面板（Collapse）和嵌套表格/描述列表的形式，详尽展示由LIEF库解析出的原始PE结构信息；特征工程页通过FeatureEngineeringCard组件，不仅用Descriptions列出各项统计值，还可能包含一个特征分布雷达图（radarOption配置），直观展示样本在节区信息、字符串匹配、Yara匹配、关键字统计、Opcode分析这五个维度的“可疑”程度评分。

（3）特征可视化组件
特征可视化组件是构成详情页的基础。除了上述提到的图表组件外，还包括各种利用Ant Design组件（如Table, Descriptions, Tag, Progress, Badge）对特定特征进行结构化展示的逻辑。例如，在PEFeaturesCard中，节区表格会根据熵值高低使用不同状态的Badge，根据内存属性（读/写/执行）使用不同颜色的Tag；在FeatureEngineeringCard中，字符串匹配和关键字统计结果会以列表或Descriptions形式清晰呈现计数和均值。


